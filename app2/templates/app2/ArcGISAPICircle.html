<!DOCTYPE html>
{% load static %}
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Sketch update validation - 4.9</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.9/esri/css/main.css">


  <script src="{% static 'js/d3.v4.min.js' %}"></script>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://js.arcgis.com/4.9/"></script>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: verdana;
    }

    #instructions {
      width: 300px;
      background: #fff;
      padding: 20px;
    }
  </style>

  <script>


    require([
      "esri/widgets/Sketch/SketchViewModel",
      "esri/Graphic",
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/geometry/Polygon",
      "esri/geometry/geometryEngine",
      "esri/widgets/Expand"
    ], function(
      SketchViewModel, Graphic, Map, MapView, FeatureLayer,
      GraphicsLayer, Polygon, geometryEngine, Expand
    ) {
      let view, sketchViewModel, graphicsLayer, boundaryPolygon,
        validSymbol,
        invalidSymbol, bufferLayer, buffers, newDevelopmentGraphic,
        instructionsExpand;
      let intersects = false,
        contains = true;



      var width=1600*1.5;
      var height=900*1.5;

      var scale=17;
      var gcx=-80.5665968;
      var gcy=37.1997589;

//  wkid: 102100 vs wkid: 4326
//wkid 102100/pix =1.5 (2444,1366/1600,900)
//wkid 102100: max x,y	[-8967606.602,	4467675.232] ;min x,y	[-8970062.142,	4466302.948]



      setUpView();
      console.log(width);
      var sites = d3.range(10)
      .map(function(d) { return [Math.random() * width, Math.random() * height]; });
      var voronoi = d3.voronoi().extent([[-1, -1], [width + 1, height + 1]]);//.extent([[-8970062.142, 4467672.843], [-8967625.712,	4466311.309]]);
      var diagram = voronoi(sites),
          links = diagram.links(),
          vpolygons = diagram.polygons();
      console.log(vpolygons);



      // creates new view and map, adds featurelayers and graphicslayer to the view


      view.when(function() {
        // Query all buffer features from the school buffers featurelayer
        bufferLayer.queryFeatures().then(function(results) {
          buffers = results.features[0].geometry;
        });

        // Add the boundary polygon and new lot polygon graphics
        addGraphics();


        // Create a new instance of sketchViewModel and set its required properties
        sketchViewModel = new SketchViewModel({
          view: view,
          layer: graphicsLayer
        });


      });


//center x,y: -8968838.254,4466990.583


      function TransPolyToGIS(x,y,pw,ph,gcx,gcy,scale){
        tx=(x-pw/2)+gcx;
        ty=(y-ph/2)+gcy;
        return [tx,ty];
      }
      function FilterBoundary(x,y,maxx,maxy,minx,miny){
        if (x>maxx) {
          x=maxx;
        }
        else if (x<minx) {
          x=minx;
        }
        if (y>maxy) {
          y=maxy;
        }
        else if (y<miny) {
          y=miny;
        }
        return [x,y];
      }
      // Add new development polygon graphic and boundary polygon graphics
      function addGraphics() {
        // transfer the voronoi polygon:vpolygons to gispolygon
        vrings=[];

        for (var i = 0; i < vpolygons.length; i=i+1) {
          tempr=[];
          for (var j=0;j<vpolygons[i].length; j=j+1){
            tempr.push(TransPolyToGIS(vpolygons[i][j][0],vpolygons[i][j][1],width,height,-8968838.254,4466990.583,scale));
          }

          tempr.push(tempr[0]);
          vrings.push(tempr);
        }

        //3D polygon rings with m-values (note that the second ring does not have m-values defined for it)

        const mpoints=[
          [
          [-8969974.956031974, 4467660.899926054],
          [-8969996.453946179, 4467128.229385236],
          [-8969589.187904881, 4466812.926643587],
          [-8969388.54070565, 4466845.173514891],
          [-8969478.115348164, 4467171.225213643],
          [-8969417.204591254, 4467310.961655965],
          [-8969567.689990677, 4467542.661397935],
          [-8969974.956031974, 4467660.899926054]
          ],
          [
          [-8969384.957719948, 4466848.756500592],
          [-8969480.504005298, 4467173.613870777],
          [-8969417.204591254, 4467310.961655965],
          [-8968971.720035817, 4467443.532126886],
          [-8968553.705037419, 4467142.561328039],
          [-8969384.957719948, 4466848.756500592]
          ],
          [
          [-8968552.510708852, 4467148.532970873],
          [-8968464.130394904, 4467167.642227942],
          [-8968685.081179772, 4467675.231868857],
          [-8969972.567374842, 4467664.482911754],
          [-8969572.467304982, 4467542.6613979945],
          [-8968969.331378683, 4467445.92078402],
          [-8968552.510708852, 4467148.532970873]
          ],
          [
          [-8968462.936066337, 4467170.030885076],
          [-8968391.276352325, 4466990.881600047],
          [-8968292.147081276, 4467037.460414155],
          [-8967665.124583678, 4467669.260226022],
          [-8968682.692522638, 4467675.231868857],
          [-8968462.936066337, 4467170.030885076]
          ],
          [
          [-8968290.95275271, 4467044.6263855565],
          [-8967667.513240812, 4467668.065897455],
          [-8967502.695898585, 4467687.175154525],
          [-8967482.39231295, 4467299.018370297],
          [-8968290.95275271, 4467044.6263855565]
          ],
          [
          [-8968396.053666594, 4466990.881600047],
          [-8968464.130394904, 4467171.225213643],
          [-8968553.705037419, 4467142.561328039],
          [-8969383.763391383, 4466843.979186324],
          [-8969589.187904881, 4466811.73231502],
          [-8969967.790060574, 4466533.453758942],
          [-8969971.373046275, 4466300.559688405],
          [-8969363.459805746, 4466302.948345539],
          [-8968398.442323728, 4466992.0759286145],
          [-8968396.053666594, 4466990.881600047]
          ],
          [
          [-8969362.265477179, 4466302.948345539],
          [-8968513.097866144, 4466302.948345539],
          [-8967468.06036995, 4466790.234400792],
          [-8967484.780970084, 4467303.795684564],
          [-8968295.730066977, 4467030.294442754],
          [-8968392.470680892, 4466984.909957213],
          [-8969362.265477179, 4466302.948345539]
          ],
          [
          [-8968513.097866144, 4466306.531331239],
          [-8967513.444855688, 4466332.806559711],
          [-8967463.28305588, 4466786.651415115],
          [-8968514.292194711, 4466310.11431694],
          [-8968513.097866144, 4466306.531331239]
        ],
          [
          [-8969997.946857108, 4467128.229385277],
          [-8969969.282971498, 4466535.245251702],
          [-8969590.083651436,4466814.718136408],
          [-8969997.946857108, 4467128.229385277]
        ],
          [
          [-8969566.495662112, 4467536.689755101],
          [-8969419.593248388,4467309.767327398],
          [-8968965.748392982,4467445.92078402],
          [-8969566.495662112, 4467536.689755101]
          ]
//-8967468.06036995, y: 4466790.234400792
        ];


        vrings=[];

        for (var i=0;i<mpoints.length;i=i+1){
          tempr=[];
          //max [-8967606.602,	4467675.232] ;min x,y	[-8970062.142,	4466302.948]
          for (var j=0;j<mpoints[i].length; j=j+1){
            tempr.push(FilterBoundary(mpoints[i][j][0],mpoints[i][j][1],-8967606.602,4467675.232,-8969950,4466302.948));
          }
          vrings.push(tempr);
        }
        const polygon = new Polygon({
          hasZ: true,
          hasM: true,
          rings: vrings,
          spatialReference: { wkid: 102100 }
        });


        //const polygon = createGeometry(vertices);
        validSymbol = createSymbol([0, 170, 255, 0.4], "solid", 2, [255,
          255, 255
        ]);
        newDevelopmentGraphic = new Graphic({
          geometry: polygon,
          symbol: validSymbol,
          attributes: {
            newDevelopment: "new store"
          }
        });

        graphicsLayer.addMany([newDevelopmentGraphic]);
      }

      function createGeometry(vertices) {
        return new Polygon({
          rings: vertices,
          spatialReference: view.spatialReference
        });
      }

      function createSymbol(color, style, width, outlineColor) {
        return {
          type: "simple-fill",
          style: style,
          color: color,
          outline: {
            color: outlineColor,
            width: width
          }
        }
      }

      // Create new view, map and layers... set up the view
      function setUpView() {

        bufferLayer = new FeatureLayer({
          portalItem: {
            id: "a1fc918a654648eb833826d1c198922e"
          }
        });

        graphicsLayer = new GraphicsLayer();

        const map = new Map({
          basemap: "satellite",
          layers: [  graphicsLayer]
        });

        view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: scale,
          center: [gcx,gcy]//,35.4
        });



      }
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <div id="instructions">
    <b>Instructions</b>
  </div>
</body>

</html>
