<!DOCTYPE html>
{% load static %}
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Data-driven continuous color - 4.13</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.13/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.13/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/CSVLayer",
        "esri/widgets/Legend",
        "esri/geometry/geometryEngine",
        "esri/geometry/Polygon",
        "esri/core/promiseUtils",
        "esri/Graphic"
      ], function(Map, MapView, FeatureLayer,CSVLayer, Legend,geometryEngine,Polygon,promiseUtils,Graphic) {
        const defaultSym = {
                  type: "simple-fill", // autocasts as new SimpleFillSymbol()
                  outline: {
                    // autocasts as new SimpleLineSymbol()
                    color: [128, 128, 128, 0.2],
                    width: "0.5px"
                  }
                };
        //console.log(povLayer);
        const csv_renderer = {
          type: "simple", // autocasts as new SimpleRenderer()
          symbol: defaultSym,
          label: "LPM",
          visualVariables: [
            {
              type: "color",
              field: "probability",
              stops: [
                {
                  value: 0.0001,
                  color: "#b7ff00",
                  label: "<0.01%"
                },
                {
                  value: 0.0003,
                  color: "#fbff00",
                  label: "<0.01%"
                },
                {
                  value: 0.0005,
                  color: "#ffbf00",
                  label: ">30%"
                },
                {
                  value: 0.0008,
                  color: "#ff7700",
                  label: "<0.01%"
                },
                {
                  value: 0.001,
                  color: "#ff0000",
                  label: ">30%"
                }
              ]
            }
          ]
        };
        const map = new Map({
          basemap: "satellite"
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-80.55645,37.2],
          zoom: 17
        });

        view.ui.add(
          new Legend({
            view: view
          }),
          "top-right"
        );

        //1, geometry area extent of the extent,
        //2, geometry points from csv file,
        //3. get geometry[] from geometryEngine.intersect(1,2)
        //4. use feature latyer to draw the 3.
        //5. user renderer, type:"unique-value"
        var csvurl="{% static 'data/data_t0_25_res_3_layer.csv' %}";

        var csvLayer = new CSVLayer({
         url: csvurl,
         copyright: "Probability of LPM"
        });
        //map.add(csvLayer);

        var t_polyarr=[];
        var t_featurelayer;
        csvLayer.queryFeatures().then(function(results){
          var t_len=0.52*(results.features[1].geometry.y-results.features[0].geometry.y);
          //console.log(results.features);
          results.features.map(function(item){
            var t_poly=new Polygon({
              rings:[[item.geometry.x-t_len,item.geometry.y-t_len],
                    [item.geometry.x-t_len,item.geometry.y+t_len],
                    [item.geometry.x+t_len,item.geometry.y+t_len],
                    [item.geometry.x+t_len,item.geometry.y-t_len],
                    [item.geometry.x-t_len,item.geometry.y-t_len]],
              spatialReference:item.geometry.spatialReference
            });
            let addFeature =  {
              geometry: t_poly,
              attributes: {
                ObjectID:item.attributes.__OBJECTID,
                probability:item.attributes.probability,
              }
            };
            t_polyarr.push(addFeature);
          });

          var t_fields=[{
            name:"ObjectID",
            alias:"ObjectID",
            type:"oid"
          },
          {
            name:"probability",
            alias:"probability",
            type:"double"
          }];
          t_featurelayer=new FeatureLayer({
            source:t_polyarr,
            renderer: csv_renderer,
            fields:t_fields,
            objectIdField: "ObjectID",
            opacity:0.5
          });

          //console.log(t_polyarr);
          map.add(t_featurelayer);
/*
          t_featurelayer.queryFeatures().then(function(results){
            // prints the array of result graphics to the console
            console.log("here");
            console.log(results.features);
          });
*/

        });

      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
